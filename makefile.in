COMPILE_FLAGS = -c -Wall -g -std=c++11 -fPIC -O3 -Iinclude `wx-config --cxxflags` -Wno-deprecated -Wno-deprecated-declarations
INSTALL_TEMP = install/
INSTALL_TEMP_NOSLASH = install
SRCS = $(shell find svector -name *.cpp)
OBJS = $(addprefix build/,$(SRCS:.cpp=.o))
deps = $(addprefix build/,$(SRCS:.cpp=.d))
HDRS = $(shell find include -name *.h)
INSTHDRS = $(addprefix $(INSTALL_TEMP),$(HDRS))
TEMPLATESRCS = $(notdir $(shell find template/Apex++2015/Apex++ -name *.cpp -o -name *.h -o -name *makefile))
INSTTEMPLATESRCS = $(addprefix $(INSTALL_TEMP)share/svector/,$(TEMPLATESRCS))

all: build/svector/libsvector.so

build/svector/libsvector.so: $(OBJS) | build/svector
	 gcc -shared -o build/svector/libsvector.so $(OBJS)

build/svector:
	mkdir -p build/svector

# The symbols $@ and $< are the file being generated and the first dependency respectively
# The $* symbol contains the same as %
build/svector/%.o: svector/%.cpp | build/svector
	@#build the associated dependency file and object files
	g++ $(COMPILE_FLAGS) -MT $@ -MMD -MP -MF build/svector/$*.td -o $@ $<
	@#After compilation, move the temporary dependency files to their proper location
	@#we have the touch command to ensure the object file is more recent than the dependency
	mv -f build/svector/$*.td build/svector/$*.d && touch build/svector/$*.o

#do nothing for dependency file prerequisites.
#We actually build the dependencies with the -MT -MMD -MP -MF commands of gcc
#but having this rule ensures that if the file doesn't exist the compilation is rerun
build/svector/%.d :

clean:
	rm -r build $(INSTALL_TEMP)lib/libsvector.so $(INSTALL_TEMP)include/svector $(INSTALL_TEMP)share/svector $(INSTALL_TEMP)bin\mkapex

install: $(INSTALL_TEMP)lib/libsvector.so $(INSTHDRS) $(INSTTEMPLATESRCS) $(INSTALL_TEMP)bin/mkapex

#The Following set of rules create the install directories, with a symlink to them
$(INSTALL_DIR):
	mkdir -p "$(INSTALL_DIR)"

$(INSTALL_TEMP): | $(INSTALL_DIR)
	@if [ -f $(INSTALL_TEMP_NOSLASH) ] ; then echo "Install link already exists - > continuing"; else ln -s "$(INSTALL_DIR)" $(INSTALL_TEMP_NOSLASH); fi

$(INSTALL_TEMP)lib: | $(INSTALL_TEMP)
	mkdir -p $(INSTALL_TEMP)lib

$(INSTALL_TEMP)bin: | $(INSTALL_TEMP)
	mkdir -p $(INSTALL_TEMP)bin

$(INSTALL_TEMP)share/svector: | $(INSTALL_TEMP)
	mkdir -p $(INSTALL_TEMP)share/svector

$(INSTALL_TEMP)include/svector/dep: | $(INSTALL_TEMP)
	mkdir -p $(INSTALL_TEMP)include/svector/dep

#This rule copies the built library
$(INSTALL_TEMP)lib/libsvector.so: build/svector/libsvector.so | $(INSTALL_TEMP)lib
	cp build/svector/libsvector.so $(INSTALL_TEMP)lib/libsvector.so

#This rule should copy all the headers over 
$(INSTALL_TEMP)include/svector/%.h: include/svector/%.h | $(INSTALL_TEMP)include/svector/dep
	cp $< $@

#This rule should copy the template over
$(INSTALL_TEMP)share/svector/%: template/Apex++2015/Apex++/% | $(INSTALL_TEMP)share/svector
	cp $< $@

#This rule copies a script for building apex projects
$(INSTALL_TEMP)bin/mkapex: | $(INSTALL_TEMP)bin
	cp template/mkapex $(INSTALL_TEMP)bin/ && chmod +x $(INSTALL_TEMP)bin/mkapex

#include all the dependency files made by gcc
$(shell mkdir -p build/svector)
include $(shell find build/svector -name *.d)
